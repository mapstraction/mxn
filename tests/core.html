<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title>Mapstraction V2 core tests</title>
		
	<script type="text/javascript" src="mxn-harness.js"></script>
		
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script src="http://api.maps.nokia.com/2.2.1/jsl.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
	nokia.Settings.set ("appId", "UFWp5rP0M5fBcQzbsbRv");
	nokia.Settings.set ("authenticationToken", "zqWjwPeH0bOM2jFd2pEsGg");
	</script>
	<meta http-equiv="X-UA-Compatible" content="IE=7; IE=EmulateIE9" />
		
	<script type="text/javascript">
	//<![CDATA[
	var provider;
	(function() {
		var providerMatch = location.search.match( /provider=([^&]*)/ ),
			providerScript, mxnScript;
		if ( providerMatch ) {
			provider = providerMatch[1];
		} else {
			provider = 'googlev3';
		}

		switch (provider) {
			case 'nokia':
				new_provider = 'googlev3';
				break;
			default:
				new_provider = 'nokia';
				break;
		}

		switch ( provider ) {
			case 'cloudmade':
				document.write('<script type="text/javascript" src="http://tile.cloudmade.com/wml/latest/web-maps-lite.js"><\/script>');
				document.write('<script type="text/javascript">');
				document.write('var cloudmade_key = "6f834cbbf6ea4f3ea798ece100d537b6";');
				document.write('<\/script>');
				break;

			case 'esri':
				document.write ('<link href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/esri/css/esri.css" media="all" rel="stylesheet" type="text/css" \/>');
				document.write ('<link href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.2/js/dojo/dijit/themes/claro/claro.css" media="all" rel="stylesheet" type="text/css" \/>');
				document.write ('<script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.2" type="text/javascript"><\/script>');
				break;
				
			case 'geocommons':
				document.write('<script type="text/javascript" src="http://geocommons.com/javascripts/f1.api.js"><\/script>');
				break;

			case 'google':
				document.write( '<script type="text/javascript" src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAY70wuSo0zF3ZtJVp5bDm1BS1Y2ErAqCHV5rDhHSzgjy23KqwdRRaoSBuZk72oDzzAYxVBjtsLqSmTw"><\/script>' );
				break;

			case 'leaflet':
				document.write('<link href="http://leaflet.cloudmade.com/dist/leaflet.css" media="all" rel="stylesheet" type="text/css" \/>');
				document.write('<script src="http://leaflet.cloudmade.com/dist/leaflet.js" type="text/javascript"><\/script>');
				break;

			case 'mapquest':
				document.write('<script src="http://www.mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js?key=Fmjtd%7Cluuan1ur29%2C2w%3Do5-9682dr" type="text/javascript"><\/script>');
				break;
				
			case 'microsoft':
				document.write('<script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.3&mkt=en-us"><\/script>');
				break;

			case 'microsoft7':
				document.write('<script charset="UTF-8" type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"><\/script>');
				document.write('<script type="text/javascript">');
				document.write('var microsoft_key = "AnSU6Nk1wZm1jU0z_Jnib5uy6ZdCllBorytKk0BBxJY2rBHVZayodUR5DxqLHlzt";');
				document.write('<\/script>');
				break;

			case 'nokia':
				// already loaded
				break;

			case 'openlayers':
				document.write( '<script type="text/javascript" src="http://dev.openlayers.org/releases/OpenLayers-2.9.1/OpenLayers.js"><\/script>' );
				break;
				
			case 'openmq':
				document.write('<script src="http://open.mapquestapi.com/sdk/js/v7.0.s/mqa.toolkit.js"><\/script>');
				break;
				
			case 'openspace':
				document.write('<script type="text/javascript" src="http://openspace.ordnancesurvey.co.uk/osmapapi/openspace.js?key=CEEFBE51588492CBE0405F0ACA6010B1"><\/script>');
				break;

			case 'ovi':
				document.write('<script src="http://api.maps.ovi.com/jsl.js" type="text/javascript" charset="utf-8"><\/script>');
				break;

			case 'yandex':
				document.write('<script src="http://api-maps.yandex.ru/2.0-stable/?load=package.standard&lang=ru-RU" type="text/javascript"><\/script >');
				break;
				
			case 'googlev3':
			default:
				// already loaded
				break;
		}

		var providers = 'googlev3, nokia';
		if (provider != 'googlev3' && provider != 'nokia') {
			providers = provider + ',' + providers;
		}
		document.write( '<script type="text/javascript" src="../source/mxn.js?(' + providers + ')"><\/script>' );
	})();
	//]]>
	</script>

	<script type="text/javascript">
	//<![CDATA[

	var events = {
		LOAD: {name: 'load', value: false},
		//CLICK: {name: 'click', value: false},
		END_PAN: {name: 'endPan', value: false},
		CHANGE_ZOOM: {name: 'changeZoom', value: false},
		MARKER_ADDED: {name: 'markerAdded', value: false},
		MARKER_REMOVED: {name: 'markerRemoved', value: false},
		POLYLINE_ADDED: {name: 'polylineAdded', value: false},
		POLYLINE_REMOVED: {name: 'polylineRemoved', value: false}
	};
	
	function logInfo(msg) {
		logMessage ('info', msg);
	}
	
	function logEvent(msg) {
		logMessage ('events', msg);
	}

	function logMessage(element, msg) {
		var	display = document.getElementById(element);
		
		display.innerHTML += msg + '<br />';
		display.scrollTop = display.scrollHeight - display.clientHeight;
		return false;
	}
	
	function arrayContains(a, obj) {
	    var i = a.length;
	    while (i--) {
	       if (a[i] === obj) {
	           return true;
	       }
	    }
	    return false;
	}
	
	var m;
	window.onload = function() {
		var actionElm = document.getElementById('actions');
		var infoElm = document.getElementById('info');		
		var eventsElm = document.getElementById('events');
		
		m = new mxn.Mapstraction('map', provider);

		// Ensure load event is handled before a subsequent call to setCenterAndZoom so
		// that the CloudMade load event fires correctly (it appears to trap the first
		// call to setCenter after map load, not the actual loading itself)

		m.load.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Map loaded for provider: ' + oEvtSource.api);
			events.LOAD.value = true;
		});

		// So far this is only necessary for leaflet.
		m.setCenterAndZoom(new mxn.LatLonPoint(37.4419, -122.1419), 10);

		m.endPan.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			var center = oEvtSource.getCenter();
			logEvent('Map pan: ' + Dump(center));
			events.END_PAN.value = true;
		});
		
		m.changeZoom.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			var zoom = oEvtSource.getZoom();
			logEvent('Change zoom: ' + zoom.toString());
			events.CHANGE_ZOOM.value = true;
		});
		
		m.markerAdded.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker added: ' + oEvtArgs.marker.labelText);
			events.MARKER_ADDED.value = true;
		});
		
		m.markerRemoved.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker removed: ' + oEvtArgs.marker.labelText);
			events.MARKER_REMOVED.value = true;
		});

		m.polylineAdded.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Polyline added');
			events.POLYLINE_ADDED.value = true;
		});

		m.polylineRemoved.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Polyline removed');
			events.POLYLINE_REMOVED.value = true;
		});

		m.click.addHandler(function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Map clicked: ' + Dump(oEvtArgs.location));
		});
		
		var markerEventHandler = function(sEvtName, oEvtSource, oEvtArgs){
			logEvent('Marker event: ' + sEvtName + ' - ' + oEvtSource.labelText);
		};
				
		var ops = [
			{ 
				desc: 'Center map', 
				action: function(){
					var point;
					var zoom;
					switch (provider) {
						case 'openspace':
							point = new mxn.LatLonPoint(52.6959, 1.6846);
							zoom = 12;
							break;
						default:
							point = new mxn.LatLonPoint(37.4419, -122.1419);
							zoom = 9;
							break;
					}
					m.setCenterAndZoom(point, zoom);
				} 
			},		 
			{
				desc: 'Pan map',
				action: function(){
					var point;
					switch (provider) {
						case 'openspace':
							point = new mxn.LatLonPoint(51.4269, -0.3339);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -122.0419);
							break;
					}
					
					m.setCenter(point, {pan: true});
				}
			},
			{
				desc: 'Get info',
				action: function(){
					logInfo('Info');
					var bb = m.getBounds();
					logInfo('Bounds:<br/>' + Dump(bb));
					var ll = m.getCenter();
					logInfo('Center: ' + Dump(ll));
					logInfo('Map type: ' + m.getMapType());
					logInfo('Zoom: ' + m.getZoom());
				}
			},
			{
				desc: 'Set zoom',
				action: function(){
					var zoom;
					switch (provider) {
						case 'openspace':
							zoom = 9;
							break;
						default:
							zoom = 8;
							break;
					}
					m.setZoom(zoom);
				}
			},
			{
				desc: 'Change type',
				action: function(){
					m.setMapType(mxn.Mapstraction.SATELLITE);
				}
			},
			{
				desc: 'Add marker',
				action: function() {
					var point;
					var mkr;
					var label;
					switch (provider) {
						case 'openspace':
							label = 'Twickenham Rugby Stadium';
							point = new mxn.LatLonPoint(51.45599, -0.34146);
							break;
							
						default:
							label = 'SFO International Terminal';
							point = new mxn.LatLonPoint(37.6156, -122.3891);
							break;
					}
					mkr = new mxn.Marker(point);
					mkr.setLabel(label);
					m.setCenter(point);
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Remove marker',
				action: function() {
					m.removeMarker(m.markers[0]);
				}
			},
			{
				desc: 'Add shape',
				action: function() {
					var shp;
					switch (provider) {
						case 'openspace':
						shp = new mxn.Polyline([
							new mxn.LatLonPoint(51.564, -0.534),
							new mxn.LatLonPoint(51.690, -0.231),
							new mxn.LatLonPoint(51.596, 0.040),
							new mxn.LatLonPoint(51.390, 0.191),
							new mxn.LatLonPoint(51.264, -0.131),
							new mxn.LatLonPoint(51.311, -0.429),
							new mxn.LatLonPoint(51.430, -0.533),
							new mxn.LatLonPoint(51.564, -0.534)
						]);
							break;
						default:
							shp = new mxn.Polyline([
								new mxn.LatLonPoint(37.805, -122.480),
								new mxn.LatLonPoint(37.678, -121.800),
								new mxn.LatLonPoint(37.238, -121.962),
								new mxn.LatLonPoint(37.462, -122.444),
								new mxn.LatLonPoint(37.805, -122.480)
							]);
							break;
					}
					shp.width = 3;
					shp.color = '#00DD55';
					shp.fillColor = '#0077FF';
					shp.opacity = 0.6;
					m.addPolyline(shp);
				}
			},
			{
				desc: 'Remove shape',
				action: function() {
					m.removePolyline(m.polylines[0]);
				}
			},
			{
				desc: 'Add marker',
				action: function(){
					var point;
					switch (provider) {
						case 'openspace':
							point = new mxn.LatLonPoint(51.40995, -0.33627);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -122.0419);
							break;
					}
					var mkr = new mxn.Marker(point);
					mkr.setLabel('Some random place');
					mkr.setInfoBubble('Some information about the random place');
					mkr.click.addHandler(markerEventHandler);
					mkr.openInfoBubble.addHandler(markerEventHandler);
					mkr.closeInfoBubble.addHandler(markerEventHandler);
					m.setCenter(point);
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Show info bubble',
				action: function(){
					m.markers[0].openBubble();
				}
			},
			{
				desc: 'Hide info bubble',
				action: function(){
					m.markers[0].closeBubble();
				}
			},
			{
				desc: 'Add marker offscreen',
				action: function(){
					var marker;
					switch (provider) {
						case 'openspace':
							point = new mxn.LatLonPoint(50.54157, -4.93825);
							break;
						default:
							point = new mxn.LatLonPoint(37.3419, -117.0419);
							break;
					}
					var mkr = new mxn.Marker(point);
					mkr.setLabel('Some other place');
					m.addMarker(mkr);
				}
			},
			{
				desc: 'Auto center',
				action: function(){
					m.autoCenterAndZoom();
				}
			},
			{
				desc: 'Add line',
				action: function(){
					var pl;
					switch (provider) {
						case 'openspace':
							pl = new mxn.Polyline([
								new mxn.LatLonPoint(51.40995, -0.33627),
								new mxn.LatLonPoint(51.4545, -2.5879),
								new mxn.LatLonPoint(50.72363, -3.53440),
								new mxn.LatLonPoint(50.54157, -4.93825)
							]);
							break;
						default:
							pl = new mxn.Polyline([
								new mxn.LatLonPoint(37.3419, -122.0419),
								new mxn.LatLonPoint(36.3419, -120.0419),
								new mxn.LatLonPoint(38.3419, -119.0419),
								new mxn.LatLonPoint(37.3419, -117.0419)
							]);
							break;
					}
					pl.color = '#00DD55';
					m.addPolyline(pl);
				}
			},
			{
				desc: 'Add All Controls',
				action: function() {
					m.addControls({
						pan:	 true,
						zoom:	 'large',
						overview: true,
						scale: true,
						map_type: true
					});
				}
			},
			{
				desc: 'Remove Controls',
				action: function() {
					m.addControls( { } );
				}
			},
			{
				desc: 'Add Small Controls',
				action: function() {
					m.addSmallControls();
				}
			},
			{
				desc: 'Add Large Controls',
				action: function() {
					m.addControls( { } );
					m.addLargeControls();
				}
			},
			{
				desc: 'Add Map Type Controls',
				action: function() {
					m.addControls( { });
					m.addMapTypeControls();
				}
			},
			/*
			{
				desc: 'Add Base map type',
				action: function() {
					m.addTileLayer("http://tile.openstreetmap.org/{Z}/{X}/{Y}.png", 1.0, "OSM", 1, 19, true);
					// m.setMapType("OSM");
				}
			},
			*/			
			{
				desc: 'Check events',
				action: function() {
					var evt;
					for (evt in events) {
						var props = events[evt];
						var check = true;
						
						if (props.hasOwnProperty('skip')) {
							var skip = props.skip.split(',');
							if (arrayContains(skip, provider)) {
								check = false;
							}
						}
						
						if (check) {
							if (props.value) {
								logInfo('Event: ' + props.name + ' passed');
							}
							else {
								infoElm.style.backgroundColor = '#FCC';
								logInfo('Event: ' + props.name + ' failed');
							}
						}
						
						else {
							logInfo ('Event: ' + props.name + ' skipped');
						}
					}
				}
			},
			
			{
				desc: 'Swap API',
				action: function(){
					if (provider == 'googlev3' || provider == 'google') {
						m.swap('map', 'nokia');
					}
					else {
						m.swap('map', 'googlev3');
					}
				}
			},
			
			
			
			{ desc: 'Done.', action: function(){} }
		];
		
		RunTests(ops, actionElm, infoElm);
	};
		
	//]]>
	</script>
	<style type="text/css">
		.box {
			float: left; 
			width: 300px; 
			margin-right: 20px;
			border: 1px solid #AAA;
		}
		
		.box h2 {
			margin: 0;
			padding: 5px;
			font-family: Arial;
			background-color: #DDD;
		}
		
		.box div {
			overflow-y: scroll;
			height:400px; 
		}

		#provider-selection {
			clear:both;
		}
	</style>
</head>
<body>
	<div style="height: 400px; width: 1000px; margin: 20px;">
		<div id="map" style="position: relative; width: 700px; height: 300px; float: left; margin: 0 20px 20px 0"></div>
		<div style="">
			<h3>Providers</h3>
			<ul id="providers" >
				<li><a href="core.html?provider=cloudmade">CloudMade</a></li>
				<li><a href="core.html?provider=esri">ESRI</a></li>
				<li><a href="core.html?provider=geocommons">GeoCommons / GeoIQ</a></li>
				<li><a href="core.html?provider=google">Google v2</a></li>
				<li><a href="core.html?provider=googlev3">Google v3</a></li>
				<li><a href="core.html?provider=leaflet">Leaflet</a></li>
				<li><a href="core.html?provider=mapquest">MapQuest</a></li>
				<li><a href="core.html?provider=openmq">MapQuest Open</a></li>
				<li><a href="core.html?provider=microsoft">Microsoft v6</a></li>
				<li><a href="core.html?provider=microsoft7">Microsoft v7</a></li>
				<li><a href="core.html?provider=nokia">Nokia</a></li>
				<li><a href="core.html?provider=openlayers">OpenLayers</a></li>
				<li><a href="core.html?provider=openspace">OS OpenSpace</a></li>
				<li><a href="core.html?provider=ovi">Ovi</a></li>
				<!--
				<li><a href="core.html?provider=yandex">Yandex</a></li>
				-->
			</ul>
		</div>
		<div style="margin-top: 20px; clear: both;">
			
			<div class="box">
				<h2>Actions</h2>
				<div id="container">
					<ol id="actions"></ol>
				</div>
			</div>
			<div class="box">
				<h2>Info</h2>
				<div id="info"></div>
			</div>
			<div class="box">
				<h2>Events</h2>
				<div id="events"></div>
			</div>
		</div>
		<p id="provider-selection">
			Run with provider: <a href="?provider=cloudmade">cloudmade</a>,
			<a href="?provider=esri">esri</a>,
			<a href="?provider=geocommons">geocommons</a>,
			<a href="?provider=google">google</a>,
			<a href="?provider=googlev3">googlev3</a>,
			<a href="?provider=leaflet">leaflet</a>,
			<a href="?provider=mapquest">mapquest</a>,
			<a href="?provider=microsoft">microsoft</a>,
			<a href="?provider=microsoft7">microsoft7</a>,
			<a href="?provider=nokia">nokia</a>,
			<a href="?provider=openlayers">openlayers</a>,
			<a href="?provider=openmq">openmq</a>,
			<a href="?provider=openspace">openspace</a>,
			<a href="?provider=ovi">ovi</a>.
			<!--
			<a href="?provider=ovi">ovi</a>,
			<a href="?provider=yandex">yandex</a>.
			-->
		</p>
		</div>
</body>
</html>

